From 296cc5113ff971f40989ed803d8eacc235db0be8 Mon Sep 17 00:00:00 2001
From: Alex Pott <alex.a.pott@googlemail.com>
Date: Sat, 21 Jun 2025 20:51:20 +0100
Subject: [PATCH 1/3] Fix serialization issue

---
 core/modules/locale/src/LocaleTranslation.php | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/core/modules/locale/src/LocaleTranslation.php b/core/modules/locale/src/LocaleTranslation.php
index a9ccc93626f0..5c23f9a2f028 100644
--- a/core/modules/locale/src/LocaleTranslation.php
+++ b/core/modules/locale/src/LocaleTranslation.php
@@ -20,7 +20,9 @@
  */
 class LocaleTranslation implements TranslatorInterface, DestructableInterface {
 
-  use DependencySerializationTrait;
+  use DependencySerializationTrait {
+    __sleep as traitSleep;
+  }
 
   /**
    * Storage for strings.
@@ -161,4 +163,12 @@ public function destruct() {
     }
   }
 
+  /**
+   * {@inheritdoc}
+   */
+  public function __sleep(): array {
+    // Do not serialize the translations array.
+    return array_diff($this->traitSleep(), ['translations']);
+  }
+
 }
-- 
GitLab


From 6b2e6bd38f6248772a87a1d32a82d7d37a12a4a3 Mon Sep 17 00:00:00 2001
From: Alex Pott <alex.a.pott@googlemail.com>
Date: Sat, 21 Jun 2025 21:27:00 +0100
Subject: [PATCH 2/3] Add a test

---
 .../tests/src/Kernel/LocaleTranslationTest.php  | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/core/modules/locale/tests/src/Kernel/LocaleTranslationTest.php b/core/modules/locale/tests/src/Kernel/LocaleTranslationTest.php
index 316384330f8b..9a52c4979f75 100644
--- a/core/modules/locale/tests/src/Kernel/LocaleTranslationTest.php
+++ b/core/modules/locale/tests/src/Kernel/LocaleTranslationTest.php
@@ -20,12 +20,29 @@ class LocaleTranslationTest extends KernelTestBase {
     'locale',
   ];
 
+  /**
+   * {@inheritdoc}
+   */
+  protected function setUp(): void {
+    parent::setUp();
+
+    $this->installSchema('locale', [
+      'locales_location',
+      'locales_source',
+      'locales_target',
+    ]);
+  }
+
   /**
    * Tests that \Drupal\locale\LocaleTranslation is serializable.
    */
   public function testSerializable(): void {
+    /** @var \Drupal\locale\LocaleTranslation $translation */
     $translation = $this->container->get('string_translator.locale.lookup');
     $this->assertInstanceOf(LocaleTranslation::class, $translation);
+    // Ensure that the \Drupal\locale\LocaleTranslation::$translations property
+    // has some cached translations in it.
+    $translation->getStringTranslation('es', 'test', '');
 
     // Prove that serialization and deserialization works without errors.
     $this->assertNotNull($translation);
-- 
GitLab


From 8acc01561057883372481d286a1033402059d266 Mon Sep 17 00:00:00 2001
From: Alex Pott <1732-alexpott@users.noreply.drupalcode.org>
Date: Sat, 21 Jun 2025 20:33:04 +0000
Subject: [PATCH 3/3] Apply 1 suggestion(s) to 1 file(s)

Co-authored-by: Jess <45385-xjm@users.noreply.drupalcode.org>
---
 core/modules/locale/src/LocaleTranslation.php | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/core/modules/locale/src/LocaleTranslation.php b/core/modules/locale/src/LocaleTranslation.php
index 5c23f9a2f028..99e852650ee6 100644
--- a/core/modules/locale/src/LocaleTranslation.php
+++ b/core/modules/locale/src/LocaleTranslation.php
@@ -167,7 +167,8 @@ public function destruct() {
    * {@inheritdoc}
    */
   public function __sleep(): array {
-    // Do not serialize the translations array.
+    // ::$translations is an array of LocaleLookup objects, which have the
+    // database service injected and therefore cannot be serialized safely.
     return array_diff($this->traitSleep(), ['translations']);
   }
 
-- 
GitLab

